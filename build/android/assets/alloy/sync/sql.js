function S4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function guid(){return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()}function Migrator(e,i){this.db=i,this.dbname=e.adapter.db_name,this.table=e.adapter.collection_name,this.idAttribute=e.adapter.idAttribute,this.column=function(e){var i=e.split(/\s+/),t=i[0];switch(t.toLowerCase()){case"string":case"varchar":case"date":case"datetime":Ti.API.warn('"'+t+'" is not a valid sqlite field, using TEXT instead');case"text":t="TEXT";break;case"int":case"tinyint":case"smallint":case"bigint":case"boolean":Ti.API.warn('"'+t+'" is not a valid sqlite field, using INTEGER instead');case"integer":t="INTEGER";break;case"double":case"float":case"decimal":case"number":Ti.API.warn('"'+e+'" is not a valid sqlite field, using REAL instead');case"real":t="REAL";break;case"blob":t="BLOB";break;case"null":t="NULL";break;default:t="TEXT"}return i[0]=t,i.join(" ")},this.createTable=function(e){var i=[],t=!1;for(var o in e.columns)o===this.idAttribute&&(t=!0),i.push(o+" "+this.column(e.columns[o]));t||this.idAttribute!==ALLOY_ID_DEFAULT||i.push(ALLOY_ID_DEFAULT+" TEXT UNIQUE");var a="CREATE TABLE IF NOT EXISTS "+this.table+" ( "+i.join(",")+")";this.db.execute(a)},this.dropTable=function(){this.db.execute("DROP TABLE IF EXISTS "+this.table)},this.insertRow=function(e){var i=[],t=[],o=[],a=!1;for(var l in e)l===this.idAttribute&&(a=!0),i.push(l),t.push(e[l]),o.push("?");a||this.idAttribute!==ALLOY_ID_DEFAULT||(i.push(this.idAttribute),t.push(guid()),o.push("?")),this.db.execute("INSERT INTO "+this.table+" ("+i.join(",")+") VALUES ("+o.join(",")+");",t)},this.deleteRow=function(e){var i="DELETE FROM "+this.table,t=_.keys(e),o=t.length,a=[],l=[];o&&(i+=" WHERE ");for(var r=0;o>r;r++)a.push(t[r]+" = ?"),l.push(e[t[r]]);i+=a.join(" AND "),this.db.execute(i,l)}}function Sync(e,i,t){var o,a,l=i.config.adapter.collection_name,r=i.config.columns,d=i.config.adapter.db_name||ALLOY_DB_DEFAULT,s=null;switch(e){case"create":case"update":s=function(){var e={};i.id||(i.id=i.idAttribute===ALLOY_ID_DEFAULT?guid():null,e[i.idAttribute]=i.id,"0.9.2"===backbone.VERSION?i.set(e,{silent:!0}):i.set(e));var t=[],_=[],s=[];for(var n in r)t.push(n),_.push(i.get(n)),s.push("?");return a="REPLACE INTO "+l+" ("+t.join(",")+") VALUES ("+s.join(",")+");",o=Ti.Database.open(d),o.execute(a,_),null===i.id&&(i.id=o.lastInsertRowId,e[i.idAttribute]=i.id,"0.9.2"===backbone.VERSION?i.set(e,{silent:!0}):i.set(e)),o.close(),i.toJSON()}();break;case"read":t.query&&t.id&&Ti.API.warn('Both "query" and "id" options were specified for model.fetch(). "id" will be ignored.'),a="SELECT * FROM "+l,t.query?a=t.query:t.id&&(a+=" WHERE "+(i.idAttribute?i.idAttribute:ALLOY_ID_DEFAULT)+" = "+(_.isString(t.id)?'"'+t.id+'"':t.id)),o=Ti.Database.open(d);var n;n=_.isString(a)?o.execute(a):o.execute(a.statement,a.params);for(var c=[],f=[],h=_.isFunction(n.fieldCount)?n.fieldCount():n.fieldCount,p=n.field.bind(n),y=0;h>y;y++)f.push(n.fieldName(y));for(;n.isValidRow();){var g={};for(y=0;h>y;y++)g[f[y]]=p(y);c.push(g),n.next()}n.close(),o.close();var I=c.length;"0.9.2"===backbone.VERSION&&(i.length=I),s=1===I?c[0]:c;break;case"delete":a="DELETE FROM "+l+" WHERE "+i.idAttribute+"=?",o=Ti.Database.open(d),o.execute(a,i.id),o.close(),s=i.toJSON()}s?(_.isFunction(t.success)&&t.success(s),"read"!==e||t.silent||i.trigger("fetch",{fromAdapter:!0})):_.isFunction(t.error)&&t.error(s)}function GetMigrationFor(e,i){var t=null,o=Ti.Database.open(e);o.execute("CREATE TABLE IF NOT EXISTS migrations (latest TEXT, model TEXT);");var a=o.execute("SELECT latest FROM migrations where model = ?;",i);return a.isValidRow()&&(t=a.field(0)+""),a.close(),o.close(),t}function Migrate(e){var i=e.migrations||[],t={};i.length&&i[i.length-1](t);var o=e.prototype.config;o.adapter.db_name=o.adapter.db_name||ALLOY_DB_DEFAULT;var a=new Migrator(o),l="undefined"==typeof o.adapter.migration||null===o.adapter.migration?t.id:o.adapter.migration;if("undefined"==typeof l||null===l){var r=Ti.Database.open(o.adapter.db_name);return a.db=r,a.createTable(o),void r.close()}l+="";var d,s=GetMigrationFor(o.adapter.db_name,o.adapter.collection_name);if(s!==l){if(s&&s>l?(d=0,i.reverse()):d=1,db=Ti.Database.open(o.adapter.db_name),a.db=db,db.execute("BEGIN;"),i.length)for(var n=0;n<i.length;n++){var c=i[n],f={};if(c(f),d){if(f.id>l)break;if(f.id<=s)continue}else{if(f.id<=l)break;if(f.id>s)continue}var h=d?"up":"down";_.isFunction(f[h])&&f[h](a)}else a.createTable(o);db.execute("DELETE FROM migrations where model = ?",o.adapter.collection_name),db.execute("INSERT INTO migrations VALUES (?,?)",l,o.adapter.collection_name),db.execute("COMMIT;"),db.close(),a.db=null}}function installDatabase(e){var i=e.adapter.db_file,t=e.adapter.collection_name,o=/(^|.*\/)([^\/]+)\.[^\/]+$/,a=i.match(o);if(null===a)throw'Invalid sql database filename "'+i+'"';e.adapter.db_name=e.adapter.db_name||a[2];var l=e.adapter.db_name;Ti.API.debug('Installing sql database "'+i+'" with name "'+l+'"');var r,d,s=Ti.Database.install(i,l),n=s.execute('pragma table_info("'+t+'");'),c={};if(n){for(;n.isValidRow();)r=n.fieldByName("name"),d=n.fieldByName("type"),c[r]=d,r!==ALLOY_ID_DEFAULT||e.adapter.idAttribute||(e.adapter.idAttribute=ALLOY_ID_DEFAULT),n.next();n.close()}else{e.adapter.idAttribute?e.adapter.idAttribute:ALLOY_ID_DEFAULT;for(var f in e.columns)r=f,d=e.columns[f],r!==ALLOY_ID_DEFAULT||e.adapter.idAttribute?f===e.adapter.idAttribute&&(d+=" UNIQUE"):e.adapter.idAttribute=ALLOY_ID_DEFAULT,c[r]=d}if(e.columns=c,e.adapter.idAttribute){if(!_.contains(_.keys(e.columns),e.adapter.idAttribute))throw'config.adapter.idAttribute "'+e.adapter.idAttribute+'" not found in list of columns for table "'+t+'"\ncolumns: ['+_.keys(e.columns).join(",")+"]"}else{Ti.API.info('No config.adapter.idAttribute specified for table "'+t+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows');var h=[],p=[];_.each(e.columns,function(e,i){p.push(i),h.push(i+" "+e)});var y=p.join(",");s.execute("ALTER TABLE "+t+" RENAME TO "+t+"_temp;"),s.execute("CREATE TABLE "+t+"("+h.join(",")+","+ALLOY_ID_DEFAULT+" TEXT UNIQUE);"),s.execute("INSERT INTO "+t+"("+y+","+ALLOY_ID_DEFAULT+") SELECT "+y+",CAST(_ROWID_ AS TEXT) FROM "+t+"_temp;"),s.execute("DROP TABLE "+t+"_temp;"),e.columns[ALLOY_ID_DEFAULT]="TEXT UNIQUE",e.adapter.idAttribute=ALLOY_ID_DEFAULT}s.close()}var _=require("alloy/underscore")._,backbone=require("alloy/backbone"),ALLOY_DB_DEFAULT="_alloy_",ALLOY_ID_DEFAULT="alloy_id",cache={config:{},Model:{}};module.exports.beforeModelCreate=function(e,i){if(cache.config[i])return cache.config[i];if("undefined"==typeof Ti.Database)throw"No support for Titanium.Database in MobileWeb environment.";return e.adapter.db_file&&installDatabase(e),e.adapter.idAttribute||(Ti.API.info('No config.adapter.idAttribute specified for table "'+e.adapter.collection_name+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows'),e.columns[ALLOY_ID_DEFAULT]="TEXT UNIQUE",e.adapter.idAttribute=ALLOY_ID_DEFAULT),cache.config[i]=e,e},module.exports.afterModelCreate=function(e,i){return cache.Model[i]?cache.Model[i]:(e=e||{},e.prototype.idAttribute=e.prototype.config.adapter.idAttribute,Migrate(e),cache.Model[i]=e,e)},module.exports.sync=Sync;